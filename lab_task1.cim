! Recommended compiler:         emacs ;
! Compile with extended memory: cim -m10 my_code.sim && ./my_code ;

begin
  external class demos="demos.atr";
  demos
  begin

    !!!!!!!!!!!!!!!!!!!!!!!!!! ;
    !!!! DEFINE VARIABLES !!!! ;
    !!!!!!!!!!!!!!!!!!!!!!!!!! ;

    !! Task Specific Variables !! ;
	  integer Tw = 110;
	  integer Tn = 20;
	  integer Tc = 0.1;
	  integer Ts = 2;
	  integer numberofpackets = 100000;
	  integer numberofservers = 2;
    long real lambda = 1000/1000;         ! Divide on 1000, because of ms;

    !! DEMOS Variables !! ;
    ref (Res) controller;
    ref (Res) server;
    ref (RDist) generatorIntensity_;
    ref (BDist) controller_, packetLoss_;
    ref (Tally) delay_;


    !!!!!!!!!!!!!!!!!!!!!!!! ;
    !!!! ENTITY CLASSES !!!! ;
    !!!!!!!!!!!!!!!!!!!!!!!! ;

    !! Entity: Packet !! ;
    Entity class Packet;
    begin
      if packetLoss_.sample then begin
        long real timestamp;
        timestamp := time;
        hold(Tw);
        hold(Tn);
        controller.acquire(1);
        hold(Tc);
        controller.release(1);
        server.acquire(1);
        hold(Ts);
        server.release(1);
        delay_.update(time-timestamp);
        outint (time-timestamp,0);
        outimage;
      end
      else begin
        outtext("0,loss");
        outimage;
      end;
    end;

    !! Entity: Generator !! ;
    Entity class Generator;
    begin
      integer i;
      for i:= 1 step 1 until numberofpackets do
        begin
          new Packet(edit("packet",i)).schedule(now);
          hold(generatorIntensity_.sample);
        end;
    end;


    !!!!!!!!!!!!!!!!!!!!!!!!! ;
    !!!! VARIABLE VALUES !!!! ;
    !!!!!!!!!!!!!!!!!!!!!!!!! ;

    !! Packet Generator Intensity !! ;
    generatorIntensity_ :- new NegExp("packet", lambda);

    !! Packet Loss Probability | 5% Loss !! ;
    packetLoss_ :- new Draw("Loss", 0.95);

    !! Delay Time Counter !! ;
    delay_ :- new Tally("delay");

    !! Controller & Server Mutex !! ;
    controller :- new Res("controller", 1);
    server :- new Res("server", numberofservers);

    !! Create New Generator Entity !! ;
    new Generator("Gen").schedule(0);

    !! Force Hold Simulation !! ;
    hold(300000000);
  end;
end;
